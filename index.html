<!DOCTYPE html>
<html>
  <head>
    <script src="jquery.js"></script>
    <script src="data_generator.js"></script>
    <script src="moment.min.js"></script>
    <link rel="stylesheet" type="text/css" href="index.css">
    <link href='http://fonts.googleapis.com/css?family=Delius+Swash+Caps|Old+Standard+TT:400,400italic' rel='stylesheet' type='text/css'>
  </head>
  <body>

    <script>
      $(document).ready(function(){

        // constructs the html of the page
        var $body = $('body');
        $body.html('');

        var $header = $('<header><h1>Welcome to Twittler</h1><h5>where your friends twittle their thumbs out loud!</h5></header>');
        $body.append($header);

        // can we append multiple elements to an element at once? then we could define all of the sub elements and have one line that appends them to the master element
        var $content = $('<div class="content"/>');
        $body.append($content);

        var $newUserLink = $('<span id="newUserLink">New user? Click here!</span>');
        $content.append($newUserLink);

        var $newUserForm = $('<div id="newUserForm"/>');
        $content.append($newUserForm);
        var $newUserField = $('<input type="text" name="newUserField" placeholder="username" id="newUserField"/>');
        $newUserForm.append($newUserField);
        var $newUserSubmit = $('<button type="button" id="newUserSubmit">Create new user</button>');
        $newUserForm.append($newUserSubmit);

        var $twittleForm = $('<div id="twittleForm"/>');
        var $messageField = $('<textarea rows="3" cols="50" placeholder="Add your twittle here!" id="messageField"></textarea><br>');
        $twittleForm.append($messageField);
        var $userField = $('<input type="text" name="userName" placeholder="Add your username here" id="userField">');
        $twittleForm.append($userField);
        var $submitButton = $('<button type="button" id="submitButton">Submit your twittle</button>');
        // add div with error message for nonexistent usernames
        $twittleForm.append($submitButton);
        $content.append($twittleForm);

        var $loadButton = $('<button type="button" id="loadButton">Load all new twittles</button>');
        $content.append($loadButton);

        var $tweetList = $('<div id="tweetList"/>');
        $content.append($tweetList);

        var $topButton = $('<button type="button" id="topButton">Back to top</button>');
        $content.append($topButton);


        // loads all twittles. is user is provided, the twittles are filtered based on that username
        function loadTweets(user) {
          $tweetList.html('');

          var stream;

          if (user && streams.users[user]) {
            stream = streams.users[user];
          } else {
            stream = streams.home;
          }

          var index = stream.length - 1;
          while(index >= 0){
            var tweet = stream[index];

            var user = tweet.user;
            var time = moment(tweet.created_at).fromNow();
            var message = tweet.message;

            var $tweet = $('<div class="tweet"><span class="user">@' + user + '</span> <span class="time">(' + time + ')</span>: <span class="message">' + message + '</span></div>');

            $tweetList.append($tweet);
            index -= 1;
          }

          $('.user').on('click', function(){
            var user = $(this).text().replace('@','');
            loadTweets(user);
          });

        }


        // event listeners

        // upon clicking "New user?" link, call slideToggle() on new user text input
        $('#newUserLink').on('click', function(){
          $('#newUserForm').slideToggle();
        });

        // upon submitting a new username, add that username to streams.users and set streams.users[username] to empty array

        $('#loadButton').on('click', function(){
          loadTweets();
        });

        $('#submitButton').on('click', function(){
          var msg = $("#messageField").val();
          var usr = $("#userField").val();
          var twt = {user: usr, message: msg, created_at: new Date()};
          addTweet(twt);
          loadTweets();
          $('#messageField').val('');
        });

        $('#topButton').on('click', function(){
          $("html, body").animate({scrollTop: 0}, "slow");
          return false;
        });


        // loads inital twittles upon loading the page
        loadTweets();

      });

    </script>
  </body>
</html>
